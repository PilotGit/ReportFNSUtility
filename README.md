# ReportFNSUtility
Как работать с Утилитой

## Работа в Оконном режиме
Что бы перейти в оконный режим необходимо запустить приложение без параметров запуска.
Оконное приложение позволяет просматривать отчеты о считывании данных с ФН и создватать эти отчеты.
### Чтение отчетов
Для чтения необходимо выбрать путь к файлу(кнопка `Обзор`) и запустить чтение файла(кнопка `Обновить`; чтение можно остановить)
### Создание отчетов
Для создания файла необходимо выбрать или ввести способ подключения к ккт(в формате `configName`), по желанию выбрать путь для сохранения и название файла.


## Консольный режим
Для запуска консоли необходимо запустить приложение с параметрами(или без них, тогда сохранение произойдет в папку с приложением,С именем заданным по умолчянию в приложении,если файл с таким же именем не существует):
- "`rw` – перезаписать файл  отчёта при совпадении имени" 
- "`P<Название_подключения>` -Название подключения к ККТ"
- "`D<Абсолютный_Путь_К_Директории>` – Путь к директории в которой будет создан файл отчёта."

Параметры можно указывать в любом порядке

# Структура отчёта в программае

## ReportFS

Класс содержащий в себе заголовок и массив фискальных документов длительного хранения.

### Поля
  |название      | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |header        | ReportHeader                  |Заголовок
  |fDLongStorage | List<Structurs>               |Массив даннхы длительного хранения
  
### Конструкторы 

**ReportFS(BinaryReader reader)**

Конструктор принимающий поток чтения. Поток чтения будет передан в соответстующий конструктор заголовка, а потом распарсен для заполнения массива данных длительного хранения путём вычленения тега и длинны и передачи тега и потока в соотвествующий конструктор STLV. 

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |reader        | BinaryReader                  |Поток чтения файла отчёта
  
  
**ReportFS()** *Устаревщее не используется*

Конструктор без параметров.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |        -      |              -                 |        -
  
### Методы

**InitHeader(string name, string programm, string numberKKT, string numberFS, byte versionFFD, uint countShift, uint fiscalDoc)** *Устаревщее не используется*

Метод вызывает конструктор заголовка передавая все необходимые поля за исключением хеша.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |name          | string                        |Название файла
  |programm      | string                        |Программа выгрузки
  |numberFS      | string                        |Номер фискального накопителя
  |versionFFD    | byte                          |Версия ФФД
  |countShift    | uint                          |Количество смен
  |fiscalDoc     | uint                          |Количество фискальных документов
  
  **AddValue(UInt16 tag)**

Метод добавляющий данные длителного хранения для последующей записи их. В метод передаётся тег (650хх) в массив данных длительного хранения добавляется новый элемент и возвращается ссылка на него.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |tag           | UInt16                        |Тег
  
**Возвращаемое значение**

  | Тип                           |Описание
  |-------------------------------|-------- 
  | Structurs                     | 
  
  **WriteFile(BinaryWriter writer)** *Устаревщее не используется*

Метод запускает процесс записи отчёта в файл, последовательно вызывая запись заголовка, массива данных длительного хранения и формирование хеша.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |writer        | BinaryWriter                  |Поток записи

## ReportHeader

Класс содержит в себе все необходимы поля заголовка отчёта и реализует функции считывания загоовка, запись заголовка в файл и формирование Хеш суммы.

### Поля
  |название      | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |name          | string                        |Название файла
  |programm      | string                        |Программа выгрузки
  |numberFS      | string                        |Номер фискального накопителя
  |versionFFD    | byte                          |Версия ФФД
  |countShift    | uint                          |Количество смен
  |fiscalDoc     | uint                          |Количество фискальных документов
  |hesh        | UInt32                  |Хеш сумма 
  
### Конструкторы 

**ReportHeader(BinaryReader reader)**

Конструктор получает поток чтения и считывает из него все поля заголовка.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |reader        | BinaryReader                  |Поток чтения
  
  
**ReportHeader(string name, string programm, string numberKKT, string numberFS, byte versionFFD, uint countShift, uint fiscalDoc)**

Конструктор получает значение всех полей за исключением хеша.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |name          | string                        |Название файла
  |programm      | string                        |Программа выгрузки
  |numberFS      | string                        |Номер фискального накопителя
  |versionFFD    | byte                          |Версия ФФД
  |countShift    | uint                          |Количество смен
  |fiscalDoc     | uint                          |Количество фискальных документов 
  
### Методы
 
  **AddHesh(UInt16 tag)**

Метод формирует и записывает хеш в полученный поток записи.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |tag           | BinaryWriter                        |Поток записи
  
  **WriteFile(BinaryWriter writer)**

Записывает в фаайл все поля заголовка за исключением хеш суммы.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |writer        | BinaryWriter                  |Поток записи

## Structurs

Класс описывающий тег и длину дочерних классов STLV и TLV. Включает в себя массивы тегов для определения 

### Поля
  |название      | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |type        | bool                  |Описание
  |parent        | Structurs                  |Описание
  |Len        | UInt16                  |Длинна
  |Tag        | UInt16                  |Тег
  
### Конструкторы 

**Structurs((UInt16 tag, UInt16 len, Structurs parent)**

Описание

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |parent        | Structurs                  |Родительская структура
  |Len        | UInt16                  |Длинна
  |Tag        | UInt16                  |Тег
  
  
**Structurs((UInt16 tag, Structurs parent)**

Конструктор принимает на вход тег и родительскую структуру если она имеется

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |parent        | Structurs                  |Родительская структура
  |Tag        | UInt16                  |Тег структуры
  
## STLV : Structurs

Класс описывающий STLV структуру. Включает в себя поле value - Значение из STLV структуры и методы позволяющие считыват данные из потока в структуру и записывать структуру в поток.

### Поля
  |название      | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |value        | Structurs[]                  |Value из STLV структуры
  
### Конструкторы 

**STLV((UInt16 tag, UInt16 len, Structurs parent)**

Конструтор принимающий на вход Тег, Длинну и родительскую структуру. Тег и длинна передают в конструктор родительного класса. Используется при считывании отчёта из потока.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |parent        | Structurs                  |Родительская структура
  |Tag        | UInt16                  |Тег структуры
  |Len        | UInt16                  |Длинна 
  
  
**STLV((UInt16 tag, Structurs parent)**

Конструтор принимающий на вход Тег и родительскую структуру. Тег передаётся в конструктор родительного класса. Используется при записи отчёта в поток.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |parent        | Structurs                  |Родительская структура
  |Tag        | UInt16                  |Тег структуры
  
### Методы


** public static void ShowTree(Fw16.Model.TLVWrapper<Fw16.Model.TLVTag> stlv, TreeNodeCollection nodes) **

Формирует дерево данных из полученного TLVWrapper в полученную коллекцию ветвей.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |stlv          | TLVWrapper<TLVTag> |Поток чтения

  |node      | TreeNodeCollection                        |Коллекция ветвей в которую добавляется значение.
  
  **AddValue(byte[] value)**

Добавляет в value новую структуру типа STLV или TLV в зависимости от переданного тега и возвращает её. 

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |tag           | UInt16                       |Тег
  
   **Возвращаемое значение**

  | Тип                           |Описание
  |-------------------------------|-------- 
  | Structurs                     | Структура
  
  **WriteFile(BinaryWriter writer)**

Запускат процесс записи тега длинны и всех значений в поток, путём вызова метода WriteFile для всех дочерних объектов.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |writer        | BinaryWriter                  |Поток записи
   
  ## TLV : Structurs

Класс описывающий STLV структуру. Включает в себя поле value - Значение из TLV структуры и методы позволяющие считыват значения из потока в структуру и записывать структуру в поток.

### Поля
  |название      | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |value        | byte[]                  |Массив байтов длинны Len 
  
### Конструкторы 

**TLV((UInt16 tag, UInt16 len, Structurs parent)**

Конструтор принимающий на вход Тег, Длинну и родительскую структуру. Тег и длинна передают в конструктор родительного класса. Используется при считывании отчёта из потока.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |parent        | Structurs                  |Родительская структура
  |Tag        | UInt16                  |Тег структуры
  |Len        | UInt16                  |Длинна 
  
  
**TLV((UInt16 tag, Structurs parent)**

Конструтор принимающий на вход Тег и родительскую структуру. Тег передаётся в конструктор родительного класса. Используется при записи отчёта в поток.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |parent        | Structurs                  |Родительская структура
  |Tag        | UInt16                  |Тег структуры
  
### Методы


** public static void ShowTree(Fw16.Model.TLVWrapper<Fw16.Model.TLVTag> stlv, TreeNodeCollection nodes) **

Формирует дерево данных из полученного TLVWrapper в полученную коллекцию ветвей.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |stlv          | TLVWrapper<TLVTag> |Поток чтения

  |node      | TreeNodeCollection                        |Коллекция ветвей в которую добавляется значение.
  
  **AddValue(byte[] value)**

Добавляет в value новую структуру типа STLV или TLV в зависимости от переданного тега и возвращает её. 

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |value           | byte[]                        |Массив байтов
   
  **WriteFile(BinaryWriter writer)**

Запускат процесс записи тега длинны и всех значений в поток.

  |Переменная    | Тип                           |Описание
  |--------------|-------------------------------|-------- 
  |writer        | BinaryWriter                  |Поток записи
